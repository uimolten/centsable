
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions for Security Logic ---
    function isAuthenticated() {
      // Checks if a user is logged in.
      return request.auth != null;
    }

    function isOwner(userId) {
      // Checks if the logged-in user's ID matches the ID of the document they are trying to access.
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- User Data (/users collection and subcollections) ---
    // This rule allows a user to read and write to their own document and all subcollections.
    // All other access is denied because server-side operations use the Admin SDK and bypass these rules.
    match /users/{userId}/{documents=**} {
      allow read, write: if isOwner(userId);
    }
    
    // --- Public Content (e.g., lessons) ---
    // This allows any logged-in user to read lessons.
    // Writes are denied from the client-side. They must be done via a secure server flow.
    match /lessons/{lessonId} {
        allow read: if isAuthenticated();
        allow write: if false;
    }
  }
}
